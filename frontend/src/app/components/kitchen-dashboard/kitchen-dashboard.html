<!-- src/app/components/kitchen-dashboard/kitchen-dashboard.component.html -->
<div class="kitchen-dashboard-container">
  <h1>Dashboard de Cocina</h1>
  <p>Gestión y seguimiento de pedidos para preparación.</p>

  <!-- === SECCIÓN DE MENSAJES === -->
  <!-- Muestra el mensaje de carga -->
  <div *ngIf="loading" class="loading-message">
    Cargando pedidos...
  </div>
  <!-- Muestra el mensaje de error si existe -->
  <div *ngIf="errorMessage" class="error-message">
    {{ errorMessage }}
  </div>
  <!-- Muestra el mensaje de éxito si existe -->
  <div *ngIf="successMessage" class="success-message">
    {{ successMessage }}
  </div>
  <!-- === FIN SECCIÓN DE MENSAJES === -->

  <!-- Controles de filtro -->
  <div class="filters">
    <label for="estadoFilter">Filtrar por Estado:</label>
    <select id="estadoFilter" [(ngModel)]="selectedEstado" (change)="loadPedidos()">
      <option value="pendiente">Pendiente</option>
      <option value="confirmado">Confirmado</option>
      <option value="en_preparacion">En Preparación</option>
      <option value="en_envio">En Envío</option>
      <option value="entregado">Entregado</option>
      <option value="cancelado">Cancelado</option>
    </select>

    <label for="searchFilter">Buscar:</label>
    <!-- El (keyup.enter) llama a loadPedidos cuando se presiona Enter en el campo de búsqueda -->
    <input type="text" id="searchFilter" [(ngModel)]="searchTerm" placeholder="ID, cliente, producto..." (keyup.enter)="loadPedidos()">
    <button (click)="loadPedidos()">Aplicar Filtros</button>
  </div>

  <!-- Tabla de Pedidos -->
  <div class="orders-table-container">
    <!-- Título condicional para la tabla -->
    <h2 *ngIf="pedidos.length > 0">Pedidos (Estado: {{ selectedEstado | titlecase }})</h2>
    <!-- Mensaje si no hay pedidos después de cargar/filtrar -->
    <div *ngIf="pedidos.length === 0 && !loading" class="no-data-message">
      No hay pedidos con los filtros aplicados.
    </div>

    <!-- La tabla se muestra solo si hay pedidos -->
    <table *ngIf="pedidos.length > 0">
      <thead>
        <tr>
          <th>ID Pedido</th>
          <th>Fecha</th>
          <th>Cliente</th>
          <th>Estado</th>
          <th>Total</th>
          <th>Detalle Productos</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let pedido of pedidos">
          <td>{{ pedido._id }}</td>
          <td>{{ pedido.fechaPedido | date:'short' }}</td>
          <!-- Acceso corregido al nombre y apellido del cliente a través de usuarioId dentro de clienteId -->
          <!-- Esto asume que clienteId SIEMPRE es un objeto IClientePopulated (no un string) -->
          <td>{{ pedido.clienteId.usuarioId?.nombre }} {{ pedido.clienteId.usuarioId?.apellido }}</td>
          <td>{{ pedido.estado | titlecase }}</td>
          <td>${{ pedido.total | number:'1.2-2' }}</td>
          <td>
            <ul>
              <li *ngFor="let item of pedido.detalleProductos">
                {{ item.cantidad }} x {{ item.nombreProducto }} (${{ item.precioUnitario | number:'1.2-2' }})
              </li>
            </ul>
          </td>
          <td>
            <!-- Botones de acción para cambiar el estado -->
            <button *ngIf="pedido.estado === 'pendiente'" (click)="changeOrderStatus(pedido._id!, 'confirmado')">
              Confirmar
            </button>
            <button *ngIf="pedido.estado === 'confirmado'" (click)="changeOrderStatus(pedido._id!, 'en_preparacion')">
              En Preparación
            </button>
            <button *ngIf="pedido.estado === 'en_preparacion'" (click)="changeOrderStatus(pedido._id!, 'en_envio')">
              Listo para Envío
            </button>
            <!-- Botón de cancelar visible si el pedido no está ya cancelado o entregado -->
            <button *ngIf="pedido.estado !== 'cancelado' && pedido.estado !== 'entregado'" (click)="changeOrderStatus(pedido._id!, 'cancelado')">
              Cancelar
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>