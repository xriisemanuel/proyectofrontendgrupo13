<div class="container mt-4">
  <h3>{{ modoEdicion ? 'Editar Producto' : 'Crear Nuevo Producto' }}</h3>
  <div class="mb-3 text-end">
    <button class="btn btn-outline-secondary btn-sm" (click)="volver()"><i class="bi bi-arrow-left-circle"></i> Volver</button>
  </div>

  <form #form="ngForm" (ngSubmit)="guardar()" class="mt-3">
    <!-- Nombre -->
    <div class="mb-3">
      <label class="form-label">Nombre</label>
      <input type="text" [(ngModel)]="producto.nombre" name="nombre" required minlength="3" maxlength="100"
        #nombre="ngModel" [class.is-invalid]="form.submitted && nombre.invalid" class="form-control">
      <div *ngIf="form.submitted && nombre.invalid" class="invalid-feedback">
        Ingres√° un nombre v√°lido (m√≠nimo 3 caracteres).
      </div>
    </div>
    <div class="mb-3">
      <button type="button" class="btn btn-outline-info btn-sm" (click)="buscarImagenSugerida()">
        Sugerir imagen desde Unsplash
      </button>
    </div>
    <!-- Bot√≥n para generar ingredientes -->
    <div class="mb-3">
      <button type="button" class="btn btn-outline-success btn-sm" (click)="generarReceta(producto.nombre)">
        Generar ingredientes desde TheMealDB üç≥
      </button>
    </div>


    <!-- Sugerencia imagen Unplash -->
    <div *ngIf="imagenSugerida" class="mb-3">
      <label class="form-label">Imagen sugerida</label>
      <img [src]="imagenSugerida" alt="Imagen sugerida" class="imagen-preview">

      <button type="button" class="btn btn-outline-success btn-sm mt-2" (click)="agregarImagenSugerida()">
        Usar esta imagen
      </button>
    </div>

    <!-- Ingredientes sugeridos como lista -->
    <ul *ngIf="ingredientesSugeridos.length > 0" class="list-group mb-3">
      <li *ngFor="let ing of ingredientesSugeridos" class="list-group-item">{{ ing }}</li>
    </ul>


    <!-- Bot√≥n para usar la receta como descripci√≥n -->
    <button type="button" class="btn btn-outline-primary btn-sm" *ngIf="recetaSugerida"
      (click)="usarRecetaComoDescripcion()">
      Usar receta como descripci√≥n ‚úçÔ∏è
    </button>

    <!-- Descripci√≥n -->
    <div class="mb-3">
      <label class="form-label">Descripci√≥n</label>
      <textarea [(ngModel)]="producto.descripcion" name="descripcion" maxlength="500" class="form-control"></textarea>
      <p class="text-success" *ngIf="producto.descripcion?.length > 0">
        ‚úÖ Descripci√≥n generada autom√°ticamente. Pod√©s editarla si quer√©s.
      </p>
    </div>
    <button type="button" class="btn btn-outline-danger btn-sm mt-2" *ngIf="producto.descripcion?.length > 0"
      (click)="limpiarDescripcion()">
      ‚ùå Descartar descripci√≥n sugerida
    </button>



    <!-- Si no se encuentra receta -->
    <p *ngIf="recetaSugerida === null" class="text-muted">
      No se encontr√≥ una receta sugerida.
    </p>

    <!-- Precio -->
    <div class="mb-3">
      <label class="form-label">Precio</label>
      <input type="number" [(ngModel)]="producto.precio" name="precio" required min="0" #precio="ngModel"
        [class.is-invalid]="form.submitted && precio.invalid" class="form-control">
      <div *ngIf="form.submitted && precio.invalid" class="invalid-feedback">
        El precio debe ser mayor o igual a $0.
      </div>
    </div>

    <!-- Stock -->
    <div class="mb-3">
      <label class="form-label">Stock</label>
      <input type="number" [(ngModel)]="producto.stock" name="stock" required min="0" #stock="ngModel"
        [class.is-invalid]="form.submitted && stock.invalid" class="form-control">
      <div *ngIf="form.submitted && stock.invalid" class="invalid-feedback">
        El stock no puede ser negativo.
      </div>
    </div>

    <!-- Im√°genes (m√∫ltiples URLs) -->
    <div class="mb-3">
      <label class="form-label">Im√°genes (URLs)</label>
      <div *ngFor="let url of producto.imagenes; let i = index" class="input-group mb-2">
        <input [(ngModel)]="producto.imagenes[i]" name="imagen{{i}}" class="form-control">
        <button type="button" class="btn btn-danger" (click)="quitarImagen(i)">‚úñ</button>
      </div>
      <button type="button" class="btn btn-outline-primary" (click)="agregarImagen()">Agregar otra imagen</button>
    </div>

    <!-- Popularidad -->
    <div class="mb-3">
      <label class="form-label">Popularidad</label>
      <input type="number" [(ngModel)]="producto.popularidad" name="popularidad" min="0" class="form-control">
    </div>

    <!-- Disponible (solo lectura, calculado desde el backend) -->
    <div class="mb-3">
      <label class="form-label">¬øDisponible?</label>
      <input type="text" [value]="producto.stock > 0 ? 'S√≠' : 'No'" readonly class="form-control bg-light">
    </div>

    <!-- Categor√≠a -->
    <label class="form-label">Categor√≠a</label>
    <select [(ngModel)]="producto.categoriaId" name="categoriaId" required #categoriaId="ngModel"
      [class.is-invalid]="form.submitted && categoriaId.invalid" class="form-select">
      <option value="" disabled selected>Seleccionar categor√≠a</option>
      <option *ngFor="let cat of categorias" [value]="cat._id">{{ cat.nombre }}</option>
    </select>


    <!-- Bot√≥n Guardar -->
    <button type="submit" class="btn btn-primary mt-1">
      {{ modoEdicion ? 'Actualizar' : 'Guardar' }}
    </button>
  </form>

  <!-- Modal de √©xito -->
  <div class="modal fade" id="modalExito" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title">¬°√âxito!</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <p>{{ mensajeModal }}</p>
        </div>
      </div>
    </div>
  </div>
</div>