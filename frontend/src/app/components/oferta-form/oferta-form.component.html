<!-- src/app/components/oferta-form/oferta-form.component.html -->
<div class="oferta-form-container">
  <h1>{{ esEdicion ? 'Editar Oferta' : 'Crear Nueva Oferta' }}</h1>
  <p>{{ esEdicion ? 'Modifica los detalles de la oferta existente.' : 'Completa los campos para crear una nueva oferta.' }}</p>

  <!-- Mensajes de carga, error o éxito -->
  <div *ngIf="cargando" class="message loading">Cargando oferta...</div>
  <div *ngIf="errorCarga" class="message error">{{ errorCarga }}</div>
  <div *ngIf="mensaje" [ngClass]="{'message': true, 'success': !errorCarga && !guardando, 'error': errorCarga, 'loading': guardando}">
    {{ mensaje }}
  </div>

  <form [formGroup]="ofertaForm" (ngSubmit)="guardarOferta()" class="oferta-form">
    <!-- Información Básica -->
    <div class="form-group">
      <label for="nombre">Nombre de la Oferta:</label>
      <input id="nombre" type="text" formControlName="nombre" class="form-control" placeholder="Ej. Descuento de Verano">
      <div *ngIf="ofertaForm.get('nombre')?.invalid && (ofertaForm.get('nombre')?.dirty || ofertaForm.get('nombre')?.touched)" class="text-danger">
        <span *ngIf="ofertaForm.get('nombre')?.errors?.['required']">El nombre es requerido.</span>
        <span *ngIf="ofertaForm.get('nombre')?.errors?.['minlength']">El nombre debe tener al menos 3 caracteres.</span>
        <span *ngIf="ofertaForm.get('nombre')?.errors?.['maxlength']">El nombre no puede exceder los 100 caracteres.</span>
      </div>
    </div>

    <div class="form-group">
      <label for="descripcion">Descripción:</label>
      <textarea id="descripcion" formControlName="descripcion" class="form-control" placeholder="Describe la oferta..."></textarea>
      <div *ngIf="ofertaForm.get('descripcion')?.errors?.['maxlength']" class="text-danger">
        La descripción no puede exceder los 500 caracteres.
      </div>
    </div>

    <!-- Descuento y Fechas -->
    <div class="form-group">
      <label for="descuento">Descuento (%):</label>
      <input id="descuento" type="number" formControlName="descuento" class="form-control" min="0" max="100">
      <div *ngIf="ofertaForm.get('descuento')?.invalid && (ofertaForm.get('descuento')?.dirty || ofertaForm.get('descuento')?.touched)" class="text-danger">
        <span *ngIf="ofertaForm.get('descuento')?.errors?.['required']">El descuento es requerido.</span>
        <span *ngIf="ofertaForm.get('descuento')?.errors?.['min'] || ofertaForm.get('descuento')?.errors?.['max']">El descuento debe estar entre 0 y 100.</span>
      </div>
    </div>

    <div class="form-group">
      <label for="fechaInicio">Fecha de Inicio:</label>
      <input id="fechaInicio" type="date" formControlName="fechaInicio" class="form-control">
      <div *ngIf="ofertaForm.get('fechaInicio')?.invalid && (ofertaForm.get('fechaInicio')?.dirty || ofertaForm.get('fechaInicio')?.touched)" class="text-danger">
        El campo Fecha de Inicio es requerido.
      </div>
    </div>

    <div class="form-group">
      <label for="fechaFin">Fecha de Fin:</label>
      <input id="fechaFin" type="date" formControlName="fechaFin" class="form-control">
      <div *ngIf="ofertaForm.get('fechaFin')?.invalid && (ofertaForm.get('fechaFin')?.dirty || ofertaForm.get('fechaFin')?.touched)" class="text-danger">
        <span *ngIf="ofertaForm.get('fechaFin')?.errors?.['required']">El campo Fecha de Fin es requerido.</span>
        <span *ngIf="ofertaForm.get('fechaFin')?.errors?.['fechaFinInvalida'] || ofertaForm.errors?.['fechasInvalidas']">La fecha de fin debe ser posterior a la fecha de inicio.</span>
      </div>
    </div>

    <div class="form-group">
      <label for="imagen">URL de la Imagen:</label>
      <input id="imagen" type="text" formControlName="imagen" class="form-control" placeholder="https://ejemplo.com/imagen.jpg">
      <div *ngIf="ofertaForm.get('imagen')?.value && !esUrlValida(ofertaForm.get('imagen')?.value)" class="text-danger">
        La URL de la imagen no es válida.
      </div>
    </div>

    <div class="form-group">
      <div class="checkbox-group">
        <label for="estado">Estado Activo:</label>
        <label class="toggle-switch">
          <input type="checkbox" id="estado" formControlName="estado">
          <span class="slider round"></span>
        </label>
      </div>
    </div>

    <!-- Selección de Productos Aplicables -->
    <div class="selection-section">
      <h3>Productos Aplicables</h3>
      <div *ngIf="productos.length === 0 && !cargando" class="text-info">No hay productos disponibles.</div>
      <div class="selection-grid">
        <div *ngFor="let producto of productos"
             class="selection-item"
             [ngClass]="{'selected': productosSeleccionados.includes(producto._id!)}"
             (click)="toggleProducto(producto._id!)">
          <input type="checkbox" [checked]="productosSeleccionados.includes(producto._id!)">
          {{ producto.nombre }}
        </div>
      </div>
    </div>

    <!-- Selección de Categorías Aplicables -->
    <div class="selection-section">
      <h3>Categorías Aplicables</h3>
      <div *ngIf="categorias.length === 0 && !cargando" class="text-info">No hay categorías disponibles.</div>
      <div class="selection-grid">
        <div *ngFor="let categoria of categorias"
             class="selection-item"
             [ngClass]="{'selected': categoriasSeleccionadas.includes(categoria._id!)}"
             (click)="toggleCategoria(categoria._id!)">
          <input type="checkbox" [checked]="categoriasSeleccionadas.includes(categoria._id!)">
          {{ categoria.nombre }}
        </div>
      </div>
    </div>

    <!-- Botones de Acción -->
    <div class="button-group">
      <button type="button" class="btn btn-secondary" (click)="volverAtras()">Volver</button>
      <button type="submit" class="btn btn-primary" [disabled]="!ofertaForm.valid || guardando">
        {{ esEdicion ? 'Actualizar Oferta' : 'Crear Oferta' }}
      </button>
    </div>
  </form>
</div>
