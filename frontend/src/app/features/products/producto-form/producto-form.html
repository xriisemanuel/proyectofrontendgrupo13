<div class="product-form-container">
    <h2>{{ isEditMode ? 'Editar Producto' : 'Nuevo Producto' }}</h2>

    <form [formGroup]="productForm" (ngSubmit)="onSubmit()">
        <div class="form-group">
            <label for="nombre">Nombre del Producto:</label>
            <input type="text" id="nombre" class="form-control" formControlName="nombre">
            <div *ngIf="productForm.get('nombre')?.invalid && (productForm.get('nombre')?.dirty || productForm.get('nombre')?.touched)"
                class="error-message">
                El nombre del producto es requerido.
            </div>
        </div>

        <div class="form-group">
            <label for="descripcion">Descripción (para IA también):</label>
            <textarea id="descripcion" class="form-control" formControlName="descripcion"></textarea>
        </div>

        <div class="form-group">
            <label for="precio">Precio:</label>
            <input type="number" id="precio" class="form-control" formControlName="precio">
            <div *ngIf="productForm.get('precio')?.invalid && (productForm.get('precio')?.dirty || productForm.get('precio')?.touched)"
                class="error-message">
                El precio es requerido y debe ser mayor o igual a 0.
            </div>
        </div>

        <div class="form-group">
            <label for="categoriaId">Categoría:</label>
            <select id="categoriaId" class="form-control" formControlName="categoriaId">
                <option value="" disabled selected>Selecciona una categoría</option>
                <option *ngFor="let cat of categories" [value]="cat._id">{{ cat.nombre }}</option>
            </select>
            <div *ngIf="productForm.get('categoriaId')?.invalid && (productForm.get('categoriaId')?.dirty || productForm.get('categoriaId')?.touched)"
                class="error-message">
                La categoría es requerida.
            </div>
        </div>

        <div class="form-group">
            <label for="stock">Stock:</label>
            <input type="number" id="stock" class="form-control" formControlName="stock">
            <div *ngIf="productForm.get('stock')?.invalid && (productForm.get('stock')?.dirty || productForm.get('stock')?.touched)"
                class="error-message">
                El stock es requerido y debe ser un número entero no negativo.
            </div>
        </div>

        <div class="form-group form-check">
            <input type="checkbox" id="disponible" class="form-check-input" formControlName="disponible">
            <label class="form-check-label" for="disponible">Disponible para la venta</label>
        </div>

        <div class="form-group">
            <label for="popularidad">Popularidad (opcional):</label>
            <input type="number" id="popularidad" class="form-control" formControlName="popularidad">
            <div *ngIf="productForm.get('popularidad')?.invalid && (productForm.get('popularidad')?.dirty || productForm.get('popularidad')?.touched)"
                class="error-message">
                La popularidad debe ser mayor o igual a 0.
            </div>
        </div>

        <div class="form-group">
            <label>Imágenes:</label>
            <div class="image-generation-section">
                <button type="button" class="btn btn-info btn-sm" (click)="generateImage()"
                    [disabled]="isGeneratingImage">
                    <i class="fas fa-magic"></i> Generar Imagen con IA
                </button>
                <span *ngIf="isGeneratingImage" class="loading-indicator">Generando...</span>
            </div>

            <div class="image-preview" *ngIf="imagePreviewUrl">
                <img [src]="imagePreviewUrl" alt="Vista previa de la imagen"
                    style="max-width: 200px; height: auto; margin-top: 10px;">
            </div>

            <div formArrayName="imagenes" class="image-list">
                <div *ngFor="let control of imagesArray.controls; let i = index" class="image-item">
                    <input type="text" class="form-control" [formControlName]="i" readonly>
                    <button type="button" class="btn btn-danger btn-sm" (click)="removeImageUrl(i)">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
                <div *ngIf="imagesArray.controls.length === 0">
                    <small class="form-text text-muted">No hay imágenes añadidas aún.</small>
                </div>
            </div>
        </div>

        <button type="submit" class="btn btn-success" [disabled]="isLoading || isGeneratingImage">
            <i class="fas fa-save"></i> {{ isLoading ? (isEditMode ? 'Guardando...' : 'Creando...') : (isEditMode ?
            'Guardar Cambios' : 'Crear Producto') }}
        </button>
        <button type="button" class="btn btn-secondary" (click)="router.navigate(['/admin/products'])">
            <i class="fas fa-ban"></i> Cancelar
        </button>
    </form>
</div>