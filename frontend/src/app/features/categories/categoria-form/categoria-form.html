<div class="categoria-form-container">
    <h2>{{ isEditMode ? 'Editar Categoría' : 'Crear Nueva Categoría' }}</h2>

    <div *ngIf="loadingData" class="loading-message">
        <p>Cargando datos de la categoría...</p>
        <div class="spinner"></div>
    </div>

    <form *ngIf="!loadingData" [formGroup]="categoriaForm" (ngSubmit)="onSubmit()" class="categoria-form">
        <div class="form-group">
            <label for="nombre">Nombre <span class="required">*</span></label>
            <input type="text" id="nombre" formControlName="nombre" class="form-control"
                [ngClass]="{'is-invalid': categoriaForm.get('nombre')?.invalid && categoriaForm.get('nombre')?.touched}">
            <div *ngIf="categoriaForm.get('nombre')?.invalid && categoriaForm.get('nombre')?.touched"
                class="invalid-feedback">
                El nombre es requerido.
            </div>
        </div>

        <div class="form-group">
            <label for="descripcion">Descripción</label>
            <textarea id="descripcion" formControlName="descripcion" class="form-control"></textarea>
        </div>

        <div class="image-generation-section">
            <h3>Generar Imagen con IA (DALL-E)</h3>
            <div class="form-group">
                <label for="imagePrompt">Descripción para la IA:</label>
                <input type="text" id="imagePrompt" formControlName="imagePrompt" class="form-control"
                    placeholder="Ej: 'Logo de una tienda de electrónica moderno, minimalista'">
                <small class="form-text text-muted">Describe la imagen que quieres generar. Sé específico.</small>
            </div>
            <button type="button" class="btn btn-generate-image" (click)="generateImage()"
                [disabled]="imageGenerationLoading">
                <span *ngIf="imageGenerationLoading" class="spinner-border spinner-border-sm" role="status"
                    aria-hidden="true"></span>
                {{ imageGenerationLoading ? 'Generando...' : 'Generar Imagen' }}
            </button>

            <div *ngIf="generatedImageUrl" class="generated-image-preview">
                <h4>Imagen Generada:</h4>
                <img [src]="generatedImageUrl" alt="Imagen generada por IA" class="preview-image-generated">
                <button type="button" class="btn btn-use-image" (click)="useGeneratedImage()">
                    Usar esta Imagen para Categoría
                </button>
            </div>
        </div>
        <div class="form-group">
            <label for="imagen">URL de Imagen (o usa la generada)</label>
            <input type="text" id="imagen" formControlName="imagen" class="form-control"
                placeholder="Ej: https://example.com/imagen.jpg">
            <div *ngIf="categoriaForm.get('imagen')?.value" class="image-preview">
                <img [src]="categoriaForm.get('imagen')?.value" alt="Vista previa de imagen actual"
                    class="preview-image">
            </div>
        </div>

        <div class="form-group form-check">
            <input type="checkbox" id="estado" formControlName="estado" class="form-check-input">
            <label class="form-check-label" for="estado">Activa</label>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary" [disabled]="isLoading">
                <span *ngIf="isLoading" class="spinner-border spinner-border-sm" role="status"
                    aria-hidden="true"></span>
                {{ isLoading ? (isEditMode ? 'Guardando...' : 'Creando...') : (isEditMode ? 'Actualizar Categoría' :
                'Crear Categoría') }}
            </button>
            <button type="button" class="btn btn-secondary" (click)="onCancel()" [disabled]="isLoading">
                Cancelar
            </button>
        </div>
    </form>
</div>